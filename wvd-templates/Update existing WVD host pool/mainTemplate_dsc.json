{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "_artifactsLocation": {
            "defaultValue": "https://raw.githubusercontent.com/Azure/RDS-Templates/user/monakran/dsc_test/wvd-templates/Update%20existing%20WVD%20host%20pool",
            "type": "string",
            "metadata": {
                "description": "The base URI where artifacts required by this template are located."
            }
        },
        "_artifactsLocationSasToken": {
            "defaultValue": "",
            "type": "securestring",
            "metadata": {
                "description": "The sasToken required to access _artifactsLocation when they're located in a storage account with private access."
            }
        },
        "rdshNamePrefix": {
            "defaultValue": "19H1EVDOFF",
            "type": "string",
            "metadata": {
                "description": "This prefix will be used in combination with the VM number to create the VM name. If using “rdsh” as the prefix, VMs would be named “rdsh-0”, “rdsh-1”, etc. You should use a unique prefix to reduce name collisions in Active Directory."
            }
        },
        "rdshNumberOfInstances": {
            "defaultValue": 4,
            "type": "int",
            "metadata": {
                "description": "Number of session hosts that will be created and added to the hostpool."
            }
        },
        "domainToJoin": {
            "defaultValue": "rdpgwcon.net",
            "type": "string",
            "metadata": {
                "description": "FQDN of the AD Domain to which session host VMs are going to be joined. For example, “contoso.com”."
            }
        },
        "existingDomainUPN": {
            "defaultValue": "tstestadmin2@rdpgwcon.net",
            "type": "string",
            "metadata": {
                "description": "A username in the domain that has privileges to join the session hosts to the domain. For example, “user1@contoso.com”."
            }
        },
        "existingDomainPassword": {
            "type": "securestring",
            "metadata": {
                "description": "The password that corresponds to the existing domain username."
            }
        },
        "rdBrokerURL": {
            "defaultValue": "https://rdbroker.wvd.microsoft.com",
            "type": "string",
            "metadata": {
                "description": "The Broker URL of the Windows Virtual Desktop deployment the session hosts will be connected to."
            }
        },
        "existingTenantGroupName": {
            "defaultValue": "Default Tenant Group",
            "type": "string",
            "metadata": {
                "description": "The name of the tenant group in the Windows Virtual Desktop deployment"
            }
        },
        "existingTenantName": {
            "defaultValue": "TestSupportedOSSKUsTenant",
            "type": "string",
            "metadata": {
                "description": "The name of the tenant in the Windows Virtual Desktop deployment."
            }
        },
        "existingHostpoolName": {
            "defaultValue": "19H1EVDOFFPOOL",
            "type": "string",
            "metadata": {
                "description": "The name of the hostpool to be in the RDS Tenant."
            }
        },
        "tenantAdminUpnOrApplicationId": {
            "defaultValue": "tstestadmin2@rdpgwcon.net",
            "type": "string",
            "metadata": {
                "description": "The template will fail if you enter a user account that requires MFA or an application that is secured by a certificate. The UPN or ApplicationId must be an RDS Owner in the Windows Virtual Desktop Tenant to create the hostpool or an RDS Owner of the host pool to provision the host pool with additional VMs."
            }
        },
        "tenantAdminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "The password that corresponds to the tenant admin UPN."
            }
        },
        "isServicePrincipal": {
            "defaultValue": false,
            "type": "bool",
            "metadata": {
                "description": "The boolean value indicating if the credentials are for a service principal."
            }
        },
        "aadTenantId": {
            "defaultValue": "",
            "type": "string",
            "metadata": {
                "description": "(Required when isServicePrincipal = True) This value identifies the Azure AD tenant of the service principal."
            }
        },
        "actionOnPreviousVirtualMachines": {
            "defaultValue": "Delete",
            "allowedValues": [
                "Deallocate",
                "Delete"
            ],
            "type": "string",
            "metadata": {
                "description": "Action to be taken on the old Azure VM resources. If delete is selected, the associated network interfaces and vhd files in Azure blob storage will also be deleted."
            }
        },
        "userLogoffDelayInMinutes": {
            "defaultValue": 2,
            "type": "int",
            "metadata": {
                "description": "Delay before users are automatically logged off from the current VMs in the hostpool."
            }
        },
        "userNotificationMessage": {
            "defaultValue": "Scheduled maintenance, please save your work and logoff as soon as possible",
            "type": "string",
            "metadata": {
                "description": "Message that will be displayed to the user notifying them of the automatic logoff."
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "(Required for Azure Marketplace.) Leave as is, unless you would like to not use a location that is different from the location of the resouce group."
            }
        }
    },
    "variables": {
        "rdshPrefix": "[concat(parameters('rdshNamePrefix'),'-')]",
        "messageTitle": "Request for Logoff",
        "existingTenantName": "[replace(parameters('existingTenantName'),'\"','')]",
        "RegistrationExpirationHours": "48",
        "rdshVmNamesOutput": {
            "copy": [
                {
                    "name": "rdshVmNamesCopy",
                    "count": "[parameters('rdshNumberOfInstances')]",
                    "input": {
                        "name": "[concat(variables('rdshPrefix'),copyIndex('rdshVmNamesCopy'))]"
                    }
                }
            ]
        }
    },
    "resources": [
        /*{
            "condition": "[greater(parameters('rdshNumberOfInstances'), 1)]",
            "apiVersion": "2018-10-01",
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "name": "[concat(variables('rdshPrefix'), '0/', 'dscextension')]",
            "location": "[parameters('location')]",
            "properties": {
                "publisher": "Microsoft.Powershell",
                "type": "DSC",
                "typeHandlerVersion": "2.73",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "modulesUrl": "[concat(parameters('_artifactsLocation'),'/DSC/tmp.zip',parameters('_artifactsLocationSasToken'))]",
                    "configurationFunction": "Configuration.ps1\\SessionHost",
                    "properties": {
                        "RDBrokerURL": "[parameters('rdBrokerURL')]",
                        "DefinedTenantGroupName": "[parameters('existingTenantGroupName')]",
                        "TenantName": "[variables('existingTenantName')]",
                        "HostPoolName": "[parameters('existingHostpoolName')]",
                        "Hours": "[variables('registrationExpirationHours')]",
                        "TenantAdminCredentials": {
                            "userName": "[parameters('tenantAdminUpnOrApplicationId')]",
                            "password": "PrivateSettingsRef:tenantAdminPassword"
                        },
                        "isServicePrincipal": "[parameters('isServicePrincipal')]",
                        "AadTenantId": "[parameters('aadTenantId')]"
                    }
                },
                "ProtectedSettings": {
                    "items": {
                        "tenantAdminPassword": "[parameters('tenantAdminPassword')]"
                    }
                }
            }
        },
        {
            "condition": "[greater(parameters('rdshNumberOfInstances'), 2)]",
            "apiVersion": "2018-10-01",
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "name": "[concat(variables('rdshPrefix'), copyindex(1),'/', 'dscextension')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                // note: if the following conditional dependencies are not dployed, arm will auto remove them
                "[concat('Microsoft.Compute/virtualMachines/', variables('rdshPrefix'),'0/extensions/dscextension')]"
            ],
            "copy": {
                "name": "additional-rdsh-dsc-loop",
                "count": "[if(less(parameters('rdshNumberOfInstances'), 3), 0, sub(parameters('rdshNumberOfInstances'), 2))]"
            },
            "properties": {
                "publisher": "Microsoft.Powershell",
                "type": "DSC",
                "typeHandlerVersion": "2.73",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "modulesUrl": "[concat(parameters('_artifactsLocation'),'/DSC/tmp.zip',parameters('_artifactsLocationSasToken'))]",
                    "configurationFunction": "Configuration.ps1\\SessionHost",
                    "properties": {
                        "RDBrokerURL": "[parameters('rdBrokerURL')]",
                        "DefinedTenantGroupName": "[parameters('existingTenantGroupName')]",
                        "TenantName": "[variables('existingTenantName')]",
                        "HostPoolName": "[parameters('existinghostpoolname')]",
                        "Hours": "[variables('registrationExpirationHours')]",
                        "TenantAdminCredentials": {
                            "userName": "[parameters('tenantAdminUpnOrApplicationId')]",
                            "password": "PrivateSettingsRef:tenantAdminPassword"
                        },
                        "isServicePrincipal": "[parameters('isServicePrincipal')]",
                        "AadTenantId": "[parameters('aadTenantId')]"
                    }
                },
                "ProtectedSettings": {
                    "items": {
                        "tenantAdminPassword": "[parameters('tenantAdminPassword')]"
                    }
                }
            }
        },*/
        {
            "apiVersion": "2018-10-01",
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "name": "[concat(variables('rdshPrefix'), sub(parameters('rdshNumberOfInstances'), 1), '/', 'dscextension')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                // note: if the following conditional dependencies are not dployed, arm will auto remove them
                "[concat('Microsoft.Compute/virtualMachines/', variables('rdshPrefix'), '0/extensions/dscextension')]",
                "additional-rdsh-dsc-loop"
                //"[if(greater(parameters('rdshNumberOfInstances'), 2), 'additional-rdsh-dsc-loop', if(equals(parameters('rdshNumberOfInstances'), 2), concat('Microsoft.Compute/virtualMachines/', variables('rdshPrefix'), '0/extensions/dscextension'), 'rdsh-domain-join-loop'))]"
            ],
            "properties": {
                "publisher": "Microsoft.Powershell",
                "type": "DSC",
                "typeHandlerVersion": "2.73",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "modulesUrl": "[concat(parameters('_artifactsLocation'),'/DSC/tmp.zip',parameters('_artifactsLocationSasToken'))]",
                    "configurationFunction": "Configuration.ps1\\SessionHost",
                    "properties": {
                        "RDBrokerURL": "[parameters('rdBrokerURL')]",
                        "DefinedTenantGroupName": "[parameters('existingTenantGroupName')]",
                        "TenantName": "[variables('existingTenantName')]",
                        "HostPoolName": "[parameters('existingHostpoolName')]",
                        "TenantAdminCredentials": {
                            "userName": "[parameters('tenantAdminUpnOrApplicationId')]",
                            "password": "PrivateSettingsRef:tenantAdminPassword"
                        },
                        "ADAdminCredentials": {
                            "userName": "[parameters('existingDomainUPN')]",
                            "password": "PrivateSettingsRef:adAdminPassword"
                        },
                        "Hours": "[variables('registrationExpirationHours')]",
                        "isServicePrincipal": "[parameters('isServicePrincipal')]",
                        "AadTenantId": "[parameters('aadTenantId')]",
                        "userLogoffDelayInMinutes": "[parameters('userLogoffDelayInMinutes')]",
                        "userNotificationMessege": "[parameters('userNotificationMessage')]",
                        "messageTitle": "[variables('messageTitle')]",
                        "deleteordeallocateVMs": "[parameters('ActionOnPreviousVirtualMachines')]",
                        "DomainName": "[parameters('domainToJoin')]",
                        "Last": true //todo confirm ?
                    }
                },
                "ProtectedSettings": {
                    "items": {
                        "tenantAdminPassword": "[parameters('tenantAdminPassword')]",
                        "adAdminPassword": "[parameters('existingDomainPassword')]"
                    }
                }
            }
        }
    ],
    "outputs": {
        "rdshVmNamesObject": {
            "value": "[variables('rdshVmNamesOutput')]",
            "type": "object"
        }
    }
}
